{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}–í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞{% endblock %}

{% block extra_css %}
<style>
    .test-selection-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .card {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 15px 20px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞—á–µ—Ç–æ–≤ */
    .quiz-item {
        border-left: 4px solid #17a2b8;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .quiz-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* –¶–≤–µ—Ç–∞ –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ */
    .quiz-urgent {
        background-color: #ffe6e6 !important;
        border-left-color: #dc3545 !important;
    }
    
    .quiz-warning {
        background-color: #fff3cd !important;
        border-left-color: #ffc107 !important;
    }
    
    .quiz-normal {
        background-color: #e8f5e8 !important;
        border-left-color: #28a745 !important;
    }
    
    .quiz-expired {
        background-color: #f8f9fa !important;
        border-left-color: #6c757d !important;
        opacity: 0.6;
    }
    
    .quiz-time-left {
        font-size: 0.9em;
        font-weight: 600;
    }
    
    .quiz-urgent .quiz-time-left {
        color: #dc3545 !important;
        font-weight: bold;
    }
    
    .quiz-warning .quiz-time-left {
        color: #856404 !important;
        font-weight: bold;
    }
    
    .quiz-normal .quiz-time-left {
        color: #155724 !important;
    }
    
    /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ü–≤–µ—Ç–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö */
    .list-group-item.quiz-urgent,
    .list-group-item.quiz-warning,
    .list-group-item.quiz-normal,
    .list-group-item.quiz-expired {
        border: 1px solid #dee2e6;
        margin: 0;
    }
    
    .btn-group-vertical {
        gap: 5px;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—á–µ—Ç–æ–≤ */
    .quiz-compact {
        padding: 15px;
    }
    
    .quiz-info {
        flex: 1;
    }
    
    .quiz-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #2c3e50;
    }
    
    .quiz-details {
        font-size: 0.85em;
        color: #6c757d;
    }
    
    .quiz-actions {
        min-width: 120px;
        text-align: right;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º */
    .test-card {
        margin-bottom: 20px;
    }

    .test-card .form-group {
        margin-bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
    .test-card .form-select, 
    .test-card .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 8px 15px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        height: 40px;
        display: flex;
        align-items: center;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 12px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 40px;
        vertical-align: middle; /* –î–æ–±–∞–≤–∏–ª –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    }

    .test-card .form-select:focus, 
    .test-card .form-control:focus {
        border-color: #4dabf7;
        box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
        outline: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ —Ç–µ—Å—Ç–æ–≤ */
    .test-card select[name$="test"] {
        height: 40px;
        min-width: 240px;
        text-align: left;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Å —á–∏—Å–ª–∞–º–∏ */
    .test-card input[type="number"] {
        min-width: 180px;
        text-align: center;
        width: 120px;
        height: 35px;
        padding-right: 15px;
        background-image: none;
        vertical-align: middle; /* –î–æ–±–∞–≤–∏–ª –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    }

    .test-card .form-label {
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.85rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 20px;
    }

    .test-card .btn {
        border-radius: 8px;
        padding: 8px 24px;
        font-weight: 600;
        font-size: 1rem;
        min-width: 200px;
        height: 35px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
    }

    .test-card .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-color: #007bff;
    }

    .test-card .btn-warning {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        border-color: #ffc107;
        color: #212529;
    }

    .test-card .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .test-card .form-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
        text-align: center;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 16px;
    }

    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    .test-card .form-row-container {
        display: flex;
        align-items: center;
        min-height: 60px;
    }

    /* –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
    .test-card .row.g-3 {
        align-items: center;
    }

    .test-card .row.g-3 > [class*="col-"] {
        padding-left: 12px;
        padding-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center; /* –î–æ–±–∞–≤–∏–ª —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
    }

    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –ø–æ –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–∏ */
    .test-card .form-select,
    .test-card .form-control,
    .test-card input[type="number"] {
        align-self: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–Ω—É—Ç—Ä–∏ flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    }

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞ */
    .test-card .col-auto .form-group {
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É */
        align-items: center;
    }

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞ */
    .express-test-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        justify-content: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É */
    }

    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
    .test-card .form-control:not(select),
    .test-card select.form-select {
        margin-top: 0;
        margin-bottom: 0;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —Ç–µ—Å—Ç–æ–≤ */
    .current-test-item {
        border-left: 4px solid #17a2b8;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .current-test-item.quiz {
        border-left-color: #dc3545;
        background-color: #ffe6e6;
    }
    
    .current-test-item.express {
        border-left-color: #ffc107;
        background-color: #fff3cd;
    }
    
    .current-test-item.normal {
        border-left-color: #28a745;
        background-color: #e8f5e8;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .test-card .row {
            flex-direction: column;
            align-items: center;
        }
        
        .test-card .col-auto {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .test-card .form-select,
        .test-card .form-control {
            width: 100%;
        }
        
        .test-card .btn {
            width: 100%;
            max-width: 300px;
            margin-left: 0;
        }

        .test-card .form-row-container {
            min-height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="test-selection-container">
    <h1 class="mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</h1>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    {% if user.is_staff %}
    <div class="nav-buttons mb-4">
        <a href="{% url 'upload_excel' %}" class="btn btn-success">
            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç –∏–∑ Excel
        </a>
        <a href="{% url 'manage_tests' %}" class="btn btn-primary">
            ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏
        </a>
    </div>
    {% endif %}
    
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞—á–µ—Ç–æ–≤ -->
    {% if available_quizzes %}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞—á–µ—Ç—ã</h5>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                {% for quiz in available_quizzes %}
                    <div class="list-group-item quiz-item quiz-compact {{ quiz|get_quiz_urgency_class }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="quiz-info">
                                <div class="quiz-title">{{ quiz.test.name }}</div>
                                <div class="quiz-details">
                                    <strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ quiz.ends_at|date:"d.m.Y H:i" }} |
                                    <span class="quiz-time-left">
                                        –û—Å—Ç–∞–ª–æ—Å—å: {{ quiz.ends_at|timeuntil }}
                                    </span>
                                </div>
                            </div>
                            <div class="quiz-actions">
                                {% if quiz.is_active %}
                                    <a href="{% url 'participate_in_quiz' quiz.id %}" class="btn btn-success btn-sm">
                                        –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                                    </a>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        –û–∂–∏–¥–∞–Ω–∏–µ
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="card-footer text-center">
                <a href="{% url 'quiz_sessions' %}" class="btn btn-outline-info btn-sm">
                    –í—Å–µ –∑–∞—á–µ—Ç—ã ‚Üí
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
    <div class="card test-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìö –û–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="normal">
                
                <div class="form-row-container">
                    <div class="row g-3 align-items-center w-100">
                        <div class="col-auto">
                            <div class="form-group">
                                {{ normal_form.test }}
                                {% if normal_form.test.errors %}
                                    <div class="text-danger small mt-1">{{ normal_form.test.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-auto">
                            <div class="form-group">
                                <label for="{{ normal_form.start_question.id_for_label }}" class="form-label small fw-bold">–° –∫–∞–∫–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</label>
                                {{ normal_form.start_question }}
                                <div class="form-text small"> 
                                </div>
                                {% if normal_form.start_question.errors %}
                                    <div class="text-danger small mt-1">{{ normal_form.start_question.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-auto">
                            <div class="form-group">
                                <label for="{{ normal_form.end_question.id_for_label }}" class="form-label small fw-bold">–ü–æ –∫–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å</label>
                                {{ normal_form.end_question }}
                                <div class="form-text small"> 
                                </div>
                                {% if normal_form.end_question.errors %}
                                    <div class="text-danger small mt-1">{{ normal_form.end_question.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-auto ms-auto"> <!-- ms-auto –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é -->
                            <button type="submit" name="normal_test" class="btn btn-primary btn-lg px-4">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                        </div>
                    </div>
                </div>
                
                {% if normal_form.non_field_errors %}
                    <div class="alert alert-danger mt-3">{{ normal_form.non_field_errors }}</div>
                {% endif %}
            </form>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞ -->
    <div class="card test-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">‚ö° –≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="express">
                
                <div class="form-row-container">
                    <div class="row g-3 align-items-center w-100">
                        <div class="col-auto">
                            <div class="form-group">
                                {{ express_form.test }}
                                {% if express_form.test.errors %}
                                    <div class="text-danger small mt-1">{{ express_form.test.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-auto">
                            <div class="express-test-group">
                                <label for="{{ express_form.question_count.id_for_label }}" class="form-label small fw-bold">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</label>
                                {{ express_form.question_count }}
                                <div class="form-text small">–û—Ç 1 –¥–æ 100</div>
                                {% if express_form.question_count.errors %}
                                    <div class="text-danger small mt-1">{{ express_form.question_count.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-auto ms-auto">
                            <button type="submit" name="express_test" class="btn btn-warning btn-lg px-4">–ù–∞—á–∞—Ç—å —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç</button>
                        </div>
                    </div>
                </div>
                
                {% if express_form.non_field_errors %}
                    <div class="alert alert-danger mt-3">{{ express_form.non_field_errors }}</div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ "–í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É -->
    {% if progress_info %}
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìã –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã</h5>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                {% for item in progress_info %}
                {% with progress=item.progress %}
                <div class="list-group-item current-test-item {{ progress.test_type }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ progress.test.name }}</h6>
                            <p class="mb-1">
                                {% if progress.test_type == 'quiz' %}
                                    <span class="badge bg-danger">–ó–∞—á–µ—Ç</span>
                                {% elif progress.test_type == 'express' %}
                                    <span class="badge bg-warning text-dark">–≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç</span>
                                {% else %}
                                    <span class="badge bg-success">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
                                {% endif %}
                                | –û—Ç–≤–µ—á–µ–Ω–æ: {{ item.answered_in_range }}/{{ item.total_in_range }}
                                | –ù–∞—á–∞—Ç: {{ progress.created_at|date:"d.m.Y H:i" }}
                            </p>
                        </div>
                        <div class="btn-group ms-3">
                            <!-- –î–ª—è –í–°–ï–• —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤ - –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å -->
                            <a href="{% url 'test_progress' progress.test.id %}" 
                               class="btn btn-success btn-sm">
                                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                            </a>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤ -->
                            {% if progress.test_type != 'quiz' %}
                            <form method="post" action="{% url 'delete_test_progress' progress.test.id %}" 
                                  class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="attempt_id" value="{{ progress.attempt_id }}">
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ—Å—Ç—É \"{{ progress.test.name }}\"?')">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}