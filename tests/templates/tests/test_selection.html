{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}–í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞{% endblock %}

{% block content %}
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <h1>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</h1>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
    {% if user.is_staff %}
    <div style="text-align: right; margin-bottom: 20px;">
        <a href="{% url 'upload_excel' %}" class="upload-excel-btn" 
           style="background-color: #28a745; color: white; padding: 10px 15px; 
                  text-decoration: none; border-radius: 4px; display: inline-block;">
            üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç –∏–∑ Excel
        </a>
        <a href="{% url 'manage_tests' %}" style="background-color: #3498db; color: white; padding: 10px 15px; 
                  text-decoration: none; border-radius: 4px; display: inline-block; margin-left: 10px;">
            ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏
        </a>
    </div>
    {% endif %}
    
    <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ—Å—Ç–∞ -->
    <div class="test-form">
        <form method="post">
            {% csrf_token %}
            <div>
                <label for="id_test">–¢–µ—Å—Ç:</label>
                {{ form.test }}
            </div>
            <div class="range-fields">
                <label>–î–∏–∞–ø–∞–∑–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
                <div style="display: flex; gap: 10px;">
                    {{ form.start_question }}
                    <span style="line-height: 40px;">–ø–æ</span>
                    {{ form.end_question }}
                </div>
            </div>
            {% if form.errors %}
                <div class="error">{{ form.non_field_errors }}</div>
            {% endif %}
            <button type="submit">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button>
        </form>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="progress-list">
        <h2>–í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç—ã</h2>
        {% for item in progress_info %}
            {% with progress=item.progress %}
            <div class="progress-item">
                <h3>{{ progress.test.name }}</h3>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –≤–æ–ø—Ä–æ—Å–æ–≤ -->
                <div class="question-range">
                    {% if progress.start_question and progress.end_question %}
                        –í–æ–ø—Ä–æ—Å—ã: —Å {{ progress.start_question }} –ø–æ {{ progress.end_question }}
                    {% elif progress.start_question %}
                        –í–æ–ø—Ä–æ—Å—ã: —Å {{ progress.start_question }} –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π
                    {% elif progress.end_question %}
                        –í–æ–ø—Ä–æ—Å—ã: —Å –ø–µ—Ä–≤–æ–≥–æ –ø–æ {{ progress.end_question }}
                    {% else %}
                        –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞
                    {% endif %}
                </div>
                
                <div class="test-stats">
                    <span>
                        {% if not progress.completed %}
                            –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å: {{ progress.current_question.question_number }}
                        {% else %}
                            –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω
                        {% endif %}
                    </span>
                </div>
                
                <div class="progress-info">
                    <p>–°—Ç–∞—Ç—É—Å: {{ progress.completed|yesno:"–ó–∞–≤–µ—Ä—à–µ–Ω,–í –ø—Ä–æ—Ü–µ—Å—Å–µ" }}</p>
                    <p>–ü—Ä–æ–≥—Ä–µ—Å—Å: 
                        {{ item.answered_in_range }}/{{ item.total_in_range }} –≤–æ–ø—Ä–æ—Å–æ–≤
                    </p>
                </div>
                
                <div class="nav-links">
                    {% if not progress.completed %}
                        <a href="{% url 'test_progress' progress.test.id %}">
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç
                        </a>
                    {% else %}
                        <a href="{% url 'test_results' progress.test.id %}">
                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </a>
                    {% endif %}
                    
                    <a href="#" onclick="return confirmReset({{ progress.test.id }})" style="background-color: #dc3545;">
                        –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                    </a>
                </div>
            </div>
            {% endwith %}
        {% empty %}
            <p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.</p>
        {% endfor %}
    </div>
    
    <div class="nav-links">
        <a href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
    </div>

    <!-- –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <style>
        .messages {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script>
    function confirmReset(testId) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –í—Å–µ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) {
            // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—É—é —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST –∑–∞–ø—Ä–æ—Å–∞
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/test/' + testId + '/reset/';
            
            // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            document.body.appendChild(form);
            form.submit();
        }
        return false;
    }
</script>
{% endblock %}