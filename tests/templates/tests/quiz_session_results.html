{% extends 'base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞—á–µ—Ç–∞: {{ quiz_session.test.name }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        /* –°–ö–†–´–í–ê–ï–ú –í–°–ï –≠–õ–ï–ú–ï–ù–¢–´ –°–¢–†–ê–ù–ò–¶–´ */
        body * {
            visibility: hidden;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–û–õ–¨–ö–û –ù–£–ñ–ù–´–ô –ö–û–ù–¢–ï–ù–¢ */
        .print-content,
        .print-content * {
            visibility: visible;
        }
        
        /* –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ù–¢–ê –î–õ–Ø –ü–ï–ß–ê–¢–ò */
        .print-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* –°–ö–†–´–í–ê–ï–ú –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ */
        .header,
        .main-nav,
        .container,
        .no-print,
        .card,
        .btn,
        .alert,
        .badge,
        .text-muted,
        .notification {
            display: none !important;
        }
        
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ü–ï–ß–ê–¢–ò */
        body {
            font-size: 12pt;
            line-height: 1.2;
            font-family: "Times New Roman", serif;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            color: black !important;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 25px;
            padding-top: 0;
        }
        
        .print-title {
            font-size: 18pt;
            font-weight: bold;
            margin-bottom: 15px;
            margin-top: 0;
        }
        
        .print-stats {
            text-align: center;
            margin-bottom: 20px;
            font-size: 12pt;
        }
        
        .print-stats span {
            margin: 0 15px;
        }
        
        .print-date {
            text-align: center;
            margin-bottom: 20px;
            font-size: 12pt;
        }
        
        .table {
            width: 100%;
            font-size: 10pt;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .table th, .table td {
            border: 1px solid #000 !important;
            padding: 6px 8px;
            text-align: center;
        }
        
        .table th {
            background-color: #f8f9fa !important;
            font-weight: bold;
        }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –ü–û–î–ü–ò–°–ò –ü–†–û–í–ï–†–Ø–Æ–©–ï–ì–û */
        .print-footer {
            text-align: right;
            margin-top: 40px;
            font-size: 11pt;
            position: relative;
        }
        
        .print-checker {
            border-top: 1px solid #000;
            padding-top: 5px;
            display: inline-block;
            min-width: 200px;
        }
        
        /* –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´ */
        @page {
            margin: 2cm;
            size: A4;
        }
        
        /* –ì–ê–†–ê–ù–¢–ò–†–£–ï–ú, –ß–¢–û –ù–ï–¢ –õ–ò–®–ù–ò–• –û–¢–°–¢–£–ü–û–í */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
        }
    }
    
    /* –°–¢–ò–õ–ò –î–õ–Ø –≠–ö–†–ê–ù–ê */
    .print-content {
        display: none;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table tbody tr:first-child td {
        background-color: #fff3cd;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞—á–µ—Ç–∞: {{ quiz_session.test.name }}</h1>
    
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <button onclick="history.back()" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
        <button onclick="printResults()" class="btn btn-primary">
            üñ®Ô∏è –ü–µ—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        </button>
    </div>
    
    <!-- –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –ü–ï–ß–ê–¢–ò -->
    <div class="print-content">
        <!-- 1. –ù–ê–ó–í–ê–ù–ò–ï –¢–ï–°–¢–ê –ü–û –¶–ï–ù–¢–†–£ -->
        <div class="print-header">
            <div class="print-title">&lt;&lt; {{ quiz_session.test.name }} &gt;&gt;</div>
        </div>
        
        <!-- 2. –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <div class="print-stats">
            <span><strong>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ total_count }}</span>
            <span><strong>–ó–∞–≤–µ—Ä—à–∏–ª–∏:</strong> {{ completed_count }}</span>
            <span><strong>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:</strong> {{ avg_score }}%</span>
        </div>
        
        <!-- 3. –î–ê–¢–ê –ü–†–û–í–ï–î–ï–ù–ò–Ø -->
        <div class="print-date">
            <strong>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> {{ quiz_session.ends_at|date:"d.m.Y" }}
        </div>
        
        <!-- 4. –¢–ê–ë–õ–ò–¶–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í -->
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th>–û—Ü–µ–Ω–∫–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                    <tr>
                        <td>
                            {% if participant.completed_at %}
                                {{ forloop.counter }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="text-align: left;">
                            {{ participant.user.profile.last_name }} 
                            {{ participant.user.first_name|first }}.
                            {% if participant.user.profile.patronymic %}
                                {{ participant.user.profile.patronymic|first }}.
                            {% endif %}
                        </td>
                        <td>
                            {% if participant.progress and participant.progress.score is not None %}
                                <strong>{{ participant.progress.score|floatformat:1 }}%</strong>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if participant.progress and participant.progress.score is not None %}
                                {% if participant.progress.score <= 50 %}
                                    –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ
                                {% elif participant.progress.score <= 70 %}
                                    —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ
                                {% elif participant.progress.score <= 90 %}
                                    —Ö–æ—Ä–æ—à–æ
                                {% else %}
                                    –æ—Ç–ª–∏—á–Ω–æ
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- 5. –ü–†–û–í–ï–†–Ø–Æ–©–ò–ô –í –ü–†–ê–í–û–ú –ù–ò–ñ–ù–ï–ú –£–ì–õ–£ -->
        <div class="print-footer">
            <div class="print-checker">
                <strong>–ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π:</strong><br>
                {{ quiz_session.creator.profile.last_name }} 
                {{ quiz_session.creator.first_name|first }}.
                {% if quiz_session.creator.profile.patronymic %}
                    {{ quiz_session.creator.profile.patronymic|first }}.
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –ö–ê–†–¢–û–ß–ö–ê –î–õ–Ø –≠–ö–†–ê–ù–ê (–ù–ï –î–õ–Ø –ü–ï–ß–ê–¢–ò) -->
    <div class="card no-print">
        <div class="card-header">
            <h5 class="mb-0">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ 
                <small class="text-muted">(–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É)</small>
            </h5>
        </div>
        <div class="card-body">
            {% if participants %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>
                                    –†–µ–∑—É–ª—å—Ç–∞—Ç 
                                    <span class="text-success">‚ñº</span>
                                </th>
                                <th>–û—Ü–µ–Ω–∫–∞</th>
                                <th>–í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                                <tr>
                                    <td>
                                        {% if participant.completed_at %}
                                            {{ forloop.counter }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ participant.user.profile.last_name }} 
                                        {{ participant.user.first_name|first }}.
                                        {% if participant.user.profile.patronymic %}
                                            {{ participant.user.profile.patronymic|first }}.
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.completed_at %}
                                            <span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                        {% else %}
                                            <span class="badge bg-warning">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.progress and participant.progress.score is not None %}
                                            <strong>{{ participant.progress.score|floatformat:1 }}%</strong>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.progress and participant.progress.score is not None %}
                                            {% if participant.progress.score <= 50 %}
                                                <span class="badge bg-danger">–Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</span>
                                            {% elif participant.progress.score <= 70 %}
                                                <span class="badge bg-warning">—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</span>
                                            {% elif participant.progress.score <= 90 %}
                                                <span class="badge bg-primary">—Ö–æ—Ä–æ—à–æ</span>
                                            {% else %}
                                                <span class="badge bg-success">–æ—Ç–ª–∏—á–Ω–æ</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.completed_at %}
                                            {{ participant.completed_at|date:"d.m.Y H:i" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.progress %}
                                            <a href="{% url 'user_test_results' participant.user.id quiz_session.test.id %}?attempt_id={{ participant.progress.attempt_id }}" 
                                               class="btn btn-sm btn-outline-primary">–î–µ—Ç–∞–ª–∏</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:</strong> –ó–∞–≤–µ—Ä—à–∏–≤—à–∏–µ —Ç–µ—Å—Ç ‚Üí –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É (–æ—Ç –ª—É—á—à–µ–≥–æ) ‚Üí –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Ä–∞–Ω—å—à–µ –ª—É—á—à–µ)
                    </small>
                </div>
            {% else %}
                <p class="text-muted">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–ß–ê–¢–ò
    function printResults() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ body
        const originalBodyContent = document.body.innerHTML;
        const originalTitle = document.title;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏
        const printContent = document.querySelector('.print-content');
        
        if (!printContent) {
            alert('–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        
        // HTML –¥–ª—è –ø–µ—á–∞—Ç–∏
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞—á–µ—Ç–∞: {{ quiz_session.test.name }}</title>
                <style>
                    body {
                        font-family: "Times New Roman", serif;
                        font-size: 12pt;
                        line-height: 1.2;
                        margin: 2cm;
                        color: #000;
                        background: #fff;
                    }
                    .print-header {
                        text-align: center;
                        margin-bottom: 25px;
                    }
                    .print-title {
                        font-size: 18pt;
                        font-weight: bold;
                        margin-bottom: 15px;
                    }
                    .print-stats {
                        text-align: center;
                        margin-bottom: 20px;
                        font-size: 12pt;
                    }
                    .print-stats span {
                        margin: 0 15px;
                    }
                    .print-date {
                        text-align: center;
                        margin-bottom: 20px;
                        font-size: 12pt;
                    }
                    .table {
                        width: 100%;
                        font-size: 10pt;
                        border-collapse: collapse;
                        margin-bottom: 30px;
                    }
                    .table th, .table td {
                        border: 1px solid #000;
                        padding: 6px 8px;
                        text-align: center;
                    }
                    .table th {
                        background-color: #f8f9fa;
                        font-weight: bold;
                    }
                    .print-footer {
                        text-align: right;
                        margin-top: 40px;
                        font-size: 11pt;
                    }
                    .print-checker {
                        border-top: 1px solid #000;
                        padding-top: 5px;
                        display: inline-block;
                        min-width: 200px;
                    }
                    @page {
                        margin: 2cm;
                        size: A4;
                    }
                </style>
            </head>
            <body>
                ${printContent.innerHTML}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç–∏–ª–µ–π
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }
</script>
{% endblock %}