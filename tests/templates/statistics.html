{% extends 'base.html' %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤{% endblock %}

{% block content %}
<div class="statistics-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤</h1>
        <a href="{% url 'profile' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
    </div>
    
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ total_trainings }}</h5>
                    <p class="card-text">–í—Å–µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ average_training_last_10 }}%</h5>
                    <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ total_express_tests }}</h5>
                    <p class="card-text">–ó–∞–≤–µ—Ä—à–µ–Ω–æ –≠–∫—Å–ø—Ä–µ—Å—Å –¢–µ—Å—Ç–æ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ average_express_last_10 }}%</h5>
                    <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –≠–∫—Å–ø—Ä–µ—Å—Å —Ç–µ—Å—Ç–æ–≤</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h5>
            <div>
                {% if has_more_trainings %}
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleTrainingView()">
                    <span id="trainingToggleText">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</span>
                </button>
                {% endif %}
                <span class="badge bg-primary">–í—Å–µ–≥–æ: {{ total_trainings }}</span>
            </div>
        </div>
        <div class="card-body">
            <div id="trainingLimitedView">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–î–∏–∞–ø–∞–∑–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in training_tests_limited %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 80 %}bg-success{% elif test.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>
                                    {% if test.start_question and test.end_question %}
                                        –í–æ–ø—Ä–æ—Å—ã {{ test.start_question }}-{{ test.end_question }}
                                    {% elif test.start_question %}
                                        –° –≤–æ–ø—Ä–æ—Å–∞ {{ test.start_question }}
                                    {% elif test.end_question %}
                                        –î–æ –≤–æ–ø—Ä–æ—Å–∞ {{ test.end_question }}
                                    {% else %}
                                        –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'test_results' test.test.id %}?attempt_id={{ test.attempt_id }}" class="btn btn-sm btn-outline-primary">
                                        –î–µ—Ç–∞–ª–∏
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p>
                                    <a href="{% url 'test_selection' %}" class="btn btn-primary">–ù–∞—á–∞—Ç—å –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if has_more_trainings %}
                <div class="text-center mt-3">
                    <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏–∑ {{ total_trainings }}</small>
                </div>
                {% endif %}
            </div>
            
            <div id="trainingFullView" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–î–∏–∞–ø–∞–∑–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in training_tests %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 80 %}bg-success{% elif test.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>
                                    {% if test.start_question and test.end_question %}
                                        –í–æ–ø—Ä–æ—Å—ã {{ test.start_question }}-{{ test.end_question }}
                                    {% elif test.start_question %}
                                        –° –≤–æ–ø—Ä–æ—Å–∞ {{ test.start_question }}
                                    {% elif test.end_question %}
                                        –î–æ –≤–æ–ø—Ä–æ—Å–∞ {{ test.end_question }}
                                    {% else %}
                                        –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'test_results' test.test.id %}?attempt_id={{ test.attempt_id }}" class="btn btn-sm btn-outline-primary">
                                        –î–µ—Ç–∞–ª–∏
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if has_more_trainings %}
                <div class="text-center mt-3">
                    <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ –≤—Å–µ—Ö {{ total_trainings }} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>‚ö° –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤</h5>
            <div>
                {% if has_more_express %}
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleExpressView()">
                    <span id="expressToggleText">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</span>
                </button>
                {% endif %}
                <span class="badge bg-primary">–í—Å–µ–≥–æ: {{ total_express_tests }}</span>
            </div>
        </div>
        <div class="card-body">
            <div id="expressLimitedView">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in express_tests_limited %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 80 %}bg-success{% elif test.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>{{ test.total_questions_count }} –≤–æ–ø—Ä–æ—Å–æ–≤</td>
                                <td>
                                    <a href="{% url 'test_results' test.test.id %}?attempt_id={{ test.attempt_id }}" class="btn btn-sm btn-outline-primary">
                                        –î–µ—Ç–∞–ª–∏
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤.</p>
                                    <a href="{% url 'test_selection' %}" class="btn btn-primary">–ü—Ä–æ–π—Ç–∏ –ø–µ—Ä–≤—ã–π —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if has_more_express %}
                <div class="text-center mt-3">
                    <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤ –∏–∑ {{ total_express_tests }}</small>
                </div>
                {% endif %}
            </div>
            
            <div id="expressFullView" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in express_tests %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 80 %}bg-success{% elif test.score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>{{ test.total_questions_count }} –≤–æ–ø—Ä–æ—Å–æ–≤</td>
                                <td>
                                    <a href="{% url 'test_results' test.test.id %}?attempt_id={{ test.attempt_id }}" class="btn btn-sm btn-outline-primary">
                                        –î–µ—Ç–∞–ª–∏
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if has_more_express %}
                <div class="text-center mt-3">
                    <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ –≤—Å–µ—Ö {{ total_express_tests }} —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ -->
    <div class="d-flex justify-content-end mt-4">
        <form method="post" action="{% url 'reset_statistics' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" 
                    onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')">
                üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            </button>
        </form>
    </div>
</div>

<style>
    .statistics-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .card {
        margin-bottom: 20px;
    }
    
    .table th {
        background-color: #f8f9fa;
    }
    
    .btn-secondary {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .badge {
        font-size: 0.8em;
    }
</style>

<script>
    function toggleTrainingView() {
        const limitedView = document.getElementById('trainingLimitedView');
        const fullView = document.getElementById('trainingFullView');
        const toggleText = document.getElementById('trainingToggleText');
        
        if (limitedView.style.display === 'none') {
            limitedView.style.display = 'block';
            fullView.style.display = 'none';
            toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
        } else {
            limitedView.style.display = 'none';
            fullView.style.display = 'block';
            toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10';
        }
    }
    
    function toggleExpressView() {
        const limitedView = document.getElementById('expressLimitedView');
        const fullView = document.getElementById('expressFullView');
        const toggleText = document.getElementById('expressToggleText');
        
        if (limitedView.style.display === 'none') {
            limitedView.style.display = 'block';
            fullView.style.display = 'none';
            toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
        } else {
            limitedView.style.display = 'none';
            fullView.style.display = 'block';
            toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
        document.getElementById('trainingLimitedView').style.display = 'block';
        document.getElementById('trainingFullView').style.display = 'none';
        document.getElementById('expressLimitedView').style.display = 'block';
        document.getElementById('expressFullView').style.display = 'none';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        document.getElementById('trainingToggleText').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
        document.getElementById('expressToggleText').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ';
    });
</script>
{% endblock %}