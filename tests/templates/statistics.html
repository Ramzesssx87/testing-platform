{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="container">
    <h1>üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'profile' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
        <form method="post" action="{% url 'reset_statistics' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤? –ó–∞—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.')">
                üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            </button>
        </form>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card mb-4">
        <div class="card-header bg-primary border-bottom">
            <h5 class="mb-0 text-white">üìà –ì—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <a href="{% url 'training_statistics' %}" class="card-link text-decoration-none">
                        <div class="card text-center hover-card">
                            <div class="card-body">
                                <h5 class="card-title">{{ total_trainings }}</h5>
                                <p class="card-text">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'express_statistics' %}" class="card-link text-decoration-none">
                        <div class="card text-center hover-card">
                            <div class="card-body">
                                <h5 class="card-title">{{ total_express_tests }}</h5>
                                <p class="card-text">–≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'quiz_statistics' %}" class="card-link text-decoration-none">
                        <div class="card text-center hover-card">
                            <div class="card-body">
                                <h5 class="card-title">{{ total_quiz_tests }}</h5>
                                <p class="card-text">–ó–∞—á–µ—Ç–æ–≤</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'all_statistics' %}" class="card-link text-decoration-none">
                        <div class="card text-center hover-card">
                            <div class="card-body">
                                <h5 class="card-title">{{ total_all_tests }}</h5>
                                <p class="card-text">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ä–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="row mb-4">
        <div class="col-md-4">
            <a href="{% url 'training_statistics' %}" class="card-link text-decoration-none">
                <div class="card text-center hover-card">
                    <div class="card-body">
                        <h5 class="card-title text-primary">{{ average_training_last_10 }}%</h5>
                        <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{% url 'express_statistics' %}" class="card-link text-decoration-none">
                <div class="card text-center hover-card">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ average_express }}%</h5>
                        <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{% url 'quiz_statistics' %}" class="card-link text-decoration-none">
                <div class="card text-center hover-card">
                    <div class="card-body">
                        <h5 class="card-title text-info">{{ average_quiz }}%</h5>
                        <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—á–µ—Ç–æ–≤</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div class="card mb-4">
        <div class="card-header bg-primary border-bottom">
            <h5 class="mb-0 text-white">üìö –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h5>
        </div>
        <div class="card-body">
            {% if training_tests_limited %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in training_tests_limited %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 90 %}bg-primary{% elif test.score >= 70 %}bg-success{% elif test.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>
                                    <a href="{% url 'user_test_all_attempts' user.id test.test.id %}" 
                                       class="btn btn-sm btn-outline-primary">–î–µ—Ç–∞–ª–∏</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if has_more_trainings %}
                    <div class="text-center mt-3">
                        <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö {{ training_tests_limited|length }} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏–∑ {{ total_trainings }}</small>
                    </div>
                {% endif %}
            {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p>
            {% endif %}
        </div>
    </div>

    <!-- –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header bg-primary border-bottom">
            <h5 class="mb-0 text-white">üöÄ –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤</h5>
        </div>
        <div class="card-body">
            {% if express_tests_limited %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in express_tests_limited %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 90 %}bg-primary{% elif test.score >= 70 %}bg-success{% elif test.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>
                                    <a href="{% url 'user_test_all_attempts' user.id test.test.id %}" 
                                       class="btn btn-sm btn-outline-primary">–î–µ—Ç–∞–ª–∏</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        –ü–æ–∫–∞–∑–∞–Ω—ã –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ {{ unique_express_tests }} —Ç–µ—Å—Ç–∞–º 
                        (–≤—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ {{ total_express_tests }} —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤)
                    </small>
                </div>
            {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤.</p>
            {% endif %}
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞—á–µ—Ç–æ–≤ -->
    <div class="card">
        <div class="card-header bg-primary border-bottom">
            <h5 class="mb-0 text-white">üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞—á–µ—Ç–æ–≤</h5>
        </div>
        <div class="card-body">
            {% if quiz_tests_limited %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in quiz_tests_limited %}
                            <tr>
                                <td>{{ test.test.name }}</td>
                                <td>{{ test.completed_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <span class="badge {% if test.score >= 90 %}bg-primary{% elif test.score >= 70 %}bg-success{% elif test.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.score|floatformat:1 }}%
                                    </span>
                                </td>
                                <td>{{ test.correct_answers_count }}/{{ test.total_questions_count }}</td>
                                <td>
                                    <a href="{% url 'user_test_all_attempts' user.id test.test.id %}" 
                                       class="btn btn-sm btn-outline-primary">–î–µ—Ç–∞–ª–∏</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        –ü–æ–∫–∞–∑–∞–Ω—ã –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ {{ unique_quiz_tests }} –∑–∞—á–µ—Ç–∞–º 
                        (–≤—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ {{ total_quiz_tests }} –∑–∞—á–µ—Ç–æ–≤)
                    </small>
                </div>
            {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞—á–µ—Ç–æ–≤.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .card-header.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border-bottom: 2px solid #004085 !important;
    }
    
    .card-header h5 {
        font-weight: 600;
        color: white !important;
    }
    
    .card {
        border: 1px solid #e9ecef;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        padding: 1rem 1.25rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .hover-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
        height: 100%;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        border-color: #007bff;
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .card-link:hover {
        text-decoration: none;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .hover-card .card-title {
        transition: all 0.3s ease;
    }

    .hover-card:hover .card-title {
        color: #007bff !important;
        transform: scale(1.05);
    }

    /* –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ä–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
    .card-link .card-body::before {
        font-size: 2rem;
        display: block;
        margin-bottom: 10px;
        opacity: 0.7;
        transition: all 0.3s ease;
    }

    .hover-card:hover .card-body::before {
        transform: scale(1.2);
        opacity: 1;
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
    .text-primary { color: #007bff !important; }
    .text-warning { color: #ffc107 !important; }
    .text-info { color: #17a2b8 !important; }

    /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –±–µ–π–¥–∂–µ–π –ø–æ 4-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ */
    .bg-primary { background-color: #007bff !important; } /* –æ—Ç–ª–∏—á–Ω–æ (90-100%) */
    .bg-success { background-color: #28a745 !important; } /* —Ö–æ—Ä–æ—à–æ (70-89%) */
    .bg-warning { background-color: #ffc107 !important; color: #212529 !important; } /* —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (50-69%) */
    .bg-danger { background-color: #dc3545 !important; } /* –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (0-49%) */
</style>
{% endblock %}