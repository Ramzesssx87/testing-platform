<!-- tests/templates/statistics_charts.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .stat-card {
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –ù–ê–í–ò–ì–ê–¶–ò–ò */
    .nav-pills .nav-link {
        color: #495057;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin: 0 5px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link.active {
        background-color: #007bff;
        color: white;
        font-weight: 600;
        border-color: #007bff;
    }
    
    .nav-pills .nav-link:hover:not(.active) {
        background-color: #e9ecef;
        color: #007bff;
        border-color: #007bff;
    }
    
    .chart-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }
    
    .hover-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        border-color: #007bff;
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .card-link:hover {
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'profile' %}">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
            <li class="breadcrumb-item"><a href="{% url 'statistics' %}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            <li class="breadcrumb-item active">
                {% if test_type == 'normal' %}–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                {% elif test_type == 'express' %}–≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã
                {% elif test_type == 'quiz' %}–ó–∞—á–µ—Ç—ã
                {% else %}–í—Å–µ —Ç–µ—Å—Ç—ã{% endif %}
            </li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            {% if test_type == 'normal' %}üìö –ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            {% elif test_type == 'express' %}üöÄ –ì—Ä–∞—Ñ–∏–∫–∏ —ç–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤
            {% elif test_type == 'quiz' %}üéØ –ì—Ä–∞—Ñ–∏–∫–∏ –∑–∞—á–µ—Ç–æ–≤
            {% else %}üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endif %}
        </h1>
        <a href="{% url 'statistics' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ</a>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º —Ç–µ—Å—Ç–æ–≤ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title text-center mb-3">üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:</h5>
            <div class="nav nav-pills nav-fill justify-content-center">
                <li class="nav-item">
                    <a class="nav-link {% if test_type == 'normal' %}active bg-primary text-white{% else %}text-dark{% endif %}" 
                       href="{% url 'training_statistics' %}">
                        üìö –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if test_type == 'express' %}active bg-warning text-dark{% else %}text-dark{% endif %}" 
                       href="{% url 'express_statistics' %}">
                        ‚ö° –≠–∫—Å–ø—Ä–µ—Å—Å-—Ç–µ—Å—Ç—ã
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if test_type == 'quiz' %}active bg-info text-white{% else %}text-dark{% endif %}" 
                       href="{% url 'quiz_statistics' %}">
                        üéØ –ó–∞—á–µ—Ç—ã
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if test_type == 'all' %}active bg-success text-white{% else %}text-dark{% endif %}" 
                       href="{% url 'all_statistics' %}">
                        üìä –í—Å–µ —Ç–µ—Å—Ç—ã
                    </a>
                </li>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center stat-card">
                <div class="card-body">
                    <h3 class="text-primary">{{ total_tests }}</h3>
                    <p class="card-text">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center stat-card">
                <div class="card-body">
                    <h3 class="text-success">{{ avg_score }}%</h3>
                    <p class="card-text">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center stat-card">
                <div class="card-body">
                    <h3 class="text-warning">{{ best_score }}%</h3>
                    <p class="card-text">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center stat-card">
                <div class="card-body">
                    <h3 class="text-danger">{{ worst_score }}%</h3>
                    <p class="card-text">–•—É–¥—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>
            </div>
        </div>
    </div>

    {% if total_tests > 0 %}
    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="row">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div class="col-md-8">
            <div class="chart-container">
                <h3 class="chart-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ({{ time_period }})</h3>
                <canvas id="progressChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="col-md-4">
            <div class="chart-container">
                <h3 class="chart-title">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                <canvas id="distributionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø —Ç–µ—Å—Ç–æ–≤ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h3 class="chart-title">üèÜ –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç–∞–º</h3>
                <canvas id="testsChart" width="400" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ -->
    {% if popular_tests %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h3 class="chart-title">‚≠ê –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã</h3>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–¢–µ—Å—Ç</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫</th>
                                <th>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in popular_tests %}
                            <tr>
                                <td>{{ test.test__name }}</td>
                                <td>{{ test.count }}</td>
                                <td>
                                    <span class="badge {% if test.avg_score >= 80 %}bg-success{% elif test.avg_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ test.avg_score|floatformat:1 }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-info text-center">
        <h4>üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {{ time_period }}.</p>
        <a href="{% url 'test_selection' %}" class="btn btn-primary">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
const progressData = {{ chart_data.progress_data|safe }};
const distributionData = {{ chart_data.score_distribution|safe }};
const testsData = {{ chart_data.tests_performance|safe }};

// –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
if (progressData && progressData.length > 0) {
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    const progressChart = new Chart(progressCtx, {
        type: 'line',
        data: {
            labels: progressData.map(item => item.date),
            datasets: [{
                label: '–†–µ–∑—É–ª—å—Ç–∞—Ç (%)',
                data: progressData.map(item => item.score),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

/// –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
if (distributionData && Object.keys(distributionData).length > 0) {
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ 4-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    const groupedData = {
        '0-50%': 0,
        '51-70%': 0,
        '71-89%': 0,
        '90-100%': 0
    };
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
    Object.keys(distributionData).forEach(range => {
        const count = distributionData[range];
        if (range === '100') {
            groupedData['90-100%'] += count;
        } else {
            const rangeStart = parseInt(range.split('-')[0]);
            if (rangeStart <= 50) groupedData['0-50%'] += count;
            else if (rangeStart <= 70) groupedData['51-70%'] += count;
            else if (rangeStart <= 90) groupedData['71-89%'] += count;
        }
    });
    
    // –¶–≤–µ—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ 4-–±–∞–ª–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    const backgroundColors = [
        '#dc3545', // –∫—Ä–∞—Å–Ω—ã–π - –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (0-50%)
        '#ffc107', // –∂–µ–ª—Ç—ã–π - —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ (51-70%)
        '#0d6efd', // —Å–∏–Ω–∏–π - —Ö–æ—Ä–æ—à–æ (71-89%)
        '#198754'  // –∑–µ–ª–µ–Ω—ã–π - –æ—Ç–ª–∏—á–Ω–æ (90-100%)
    ];
    
    const distributionChart = new Chart(distributionCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(groupedData),
            datasets: [{
                data: Object.values(groupedData),
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                title: {
                    display: true,
                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–∏—Å—Ç–µ–º–µ –æ—Ü–µ–Ω–æ–∫'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —Ç–µ—Å—Ç–∞–º
if (testsData && testsData.length > 0) {
    const testsCtx = document.getElementById('testsChart').getContext('2d');
    const testsChart = new Chart(testsCtx, {
        type: 'bar',
        data: {
            labels: testsData.map(item => item.test.length > 20 ? item.test.substring(0, 20) + '...' : item.test),
            datasets: [{
                label: '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (%)',
                data: testsData.map(item => item.avg_score),
                backgroundColor: testsData.map((_, index) => 
                    index % 2 === 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(23, 162, 184, 0.7)'
                )
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç–∞–º'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}
</script>
{% endblock %}